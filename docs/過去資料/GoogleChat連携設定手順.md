# Google Chat連携 設定手順書

## 1. 概要

このドキュメントは、日報分析ツールとGoogle Chatを連携させるための、Google Cloud Platform (GCP) および Google Chat Botのセットアップ手順を説明します。

## 2. Google Cloud Platform (GCP) での準備

### STEP 2.1: Google Chat APIの有効化

1.  [Google Cloud Console](https://console.cloud.google.com/) にアクセスし、このGASプロジェクトに紐づいているGCPプロジェクトを選択します。
2.  ナビゲーションメニューから `APIとサービス` > `ライブラリ` を選択します。
3.  検索バーに「`Google Chat API`」と入力し、表示されたGoogle Chat APIをクリックして「有効にする」ボタンを押します。

### STEP 2.2: OAuth同意画面の設定

GASがGoogle Chat APIを呼び出すために、OAuth同意画面を設定する必要があります。

1.  ナビゲーションメニューから `APIとサービス` > `OAuth同意画面` を選択します。
2.  「ユーザーの種類」で `内部` を選択し、「作成」をクリックします。
3.  **アプリ名**（例: `日報分析Bot`）を入力し、**ユーザーサポートメール**と**デベロッパーの連絡先情報**にあなたのメールアドレスを入力します。
4.  「保存して次へ」をクリックし、スコープの設定は何も変更せずに「保存して次へ」を繰り返して完了します。

## 3. Google Chat Bot の設定

### STEP 3.1: Botの作成

1.  Google Cloud Consoleのナビゲーションメニュー（左上のハンバーガーアイコン）から「APIとサービス」 > 「有効なAPIとサービス」を選択し、APIのリストの中から「Google Chat API」をクリックします。
2.  表示された「Google Chat API」の管理画面で、左側のメニューから `設定` をクリックします。
3.  以下の通りにBotの情報を設定します。
    *   **アプリ名**: `日報分析Bot` など、分かりやすい名前を入力します。
    *   **アバターのURL**: Botのアイコン画像のURLを入力します。（例: `https://.../icon.png`）
    *   **説明**: 「日報の収集と分析を行うBotです」など、簡単な説明を入力します。
    *   **機能**: `1 対 1 のメッセージを許可する` と `スペースとグループ会話に参加する` の両方にチェックを入れます。

### STEP 3.2: 接続設定（GASとの連携）

GASで作成したウェブアプリを、Botがイベント（メッセージ受信やカードクリックなど）を送信する先として設定します。

1.  **接続設定**のセクションで、`アプリのURL` を選択します。
2.  GASエディタに戻り、`デプロイ` > `新しいデプロイ` をクリックします。
    *   **種類の選択**: `ウェブアプリ`
    *   **次のユーザーとして実行**: `自分`
    *   **アクセスできるユーザー**: `全員`
    *   「デプロイ」をクリックし、表示された**ウェブアプリのURLをコピー**します。
3.  GCPのBot設定画面に戻り、コピーしたウェブアプリのURLを以下の**4つの項目すべて**に貼り付けます。
    *   **アプリのコマンド**: `/`コマンドが入力された際のイベント通知先
    *   **スペースへの追加**: Botがスペースに追加された際のイベント通知先
    *   **メッセージ**: BotへのメンションやDMが送信された際のイベント通知先
    *   **スペースから削除**: Botがスペースから削除された際のイベント通知先
    *   **理由**: 本ツールでは、GASの`doPost(e)`関数が全てのイベントを受け取る単一の窓口として機能するため、すべてのイベント通知先を同じURLに設定します。
4.  「保存」をクリックして、Botの設定を完了します。

## 4. スクリプトプロパティへの設定

このツールは、サービスアカウントキーを使用せず、スクリプト実行者自身の権限でGoogle Chat APIを呼び出します。そのため、`GOOGLE_CHAT_SERVICE_ACCOUNT_KEY_JSON` の設定は不要です。

また、Google ChatのスペースIDはスプレッドシートで管理するため、`GOOGLE_CHAT_SPACE_IDS` の設定も不要です。

代わりに、以下のプロパティが正しく設定されていることを確認してください。

| プロパティ名 | 設定値 | 説明 |
| :--- | :--- | :--- |
| `GEMINI_API_KEY` | `AIzaSy...` | あなたのGemini APIキー。 |
| `TARGET_EMPLOYEE_NAME_FOR_1ON1` | `山田太郎` | (任意) 1on1ヒアリング項目を生成したい社員の氏名。 |
| `SELF_EVALUATION_FOLDER_ID` | `your_google_drive_folder_id` | (任意) 自己評価シートが保存されているGoogleドライブのフォルダID。 |
| `SELF_EVALUATION_INPUT_SHEET_NAME` | `簡易評価入力` | (任意) 自己評価シート内のデータ入力シート名。 |

以上で、Google Chat連携のためのすべての設定は完了です。

---
最終更新日: 2025/07/14