---
## Google Apps Script (GAS) × Google Chat 連携開発ナレッジ

Google ChatとGASの連携は、業務自動化において非常に強力ですが、その過程には特有の「罠」が数多く存在します。このナレッジは、開発中に発生しがちな問題とその解決策をまとめたものです。

### 1. 認証と権限 - 最大のハマりポイント

#### 問題1-1: `404 Not Found` エラーが頻発する

APIを呼び出すと`404 Not Found`エラーが返ってくる場合、原因は多岐にわたりますが、根本的には**「APIを呼び出している主体（Botやあなた）が、送信先のスペースを認識できていない」**状態です。

*   **原因A: Botがスペースのメンバーではない（最重要）**
    *   **解説**: サービスアカウントを利用したBotは、人間と同じように、メッセージを投稿したいスペースの**メンバーとして追加**されている必要があります。
    *   **対策**: サービスアカウントのメールアドレス（`...@...gserviceaccount.com`）を、対象のスペースにメンバーとして招待してください。

*   **原因B: ユーザーからの初回コンタクトがない（DMの場合）**
    *   **解説**: BotからユーザーへのDMを送信するには、**先にユーザー側からBotに対して一度メッセージを送る**ことで、「会話の経路」を確立する必要があります。
    *   **対策**: Botを利用する全ユーザーに、初回のみBotを検索して何かメッセージを送ってもらうよう案内してください。

*   **原因C: Google Workspaceのセキュリティ設定**
    *   **解説**: 組織の管理者が「組織外のユーザーをスペースに追加する」ことを許可していない場合、サービスアカウント（外部ユーザー扱い）を招待できず、エラーになります。
    *   **対策**: Workspace管理者に設定変更を依頼するか、後述の「実行者自身の権限で動作する方式」に切り替えてください。

#### 問題1-2: スクリプトの権限が承認されず、`doPost`が応答しない

*   **現象**: Google Chatからの呼び出しで`doPost`の実行ログは記録されるが、中身は空で、Chatにも応答がない。
*   **原因**: `doPost`はGoogleのサーバーによって自動実行されるため、ユーザーに権限承認を求める画面が表示されません。必要な権限（スプレッドシートへのアクセス、外部URLへのアクセスなど）が未承認だと、関数が開始直後にサイレントに失敗します。
*   **解決策**: GASエディタから、権限が必要な関数（例: `sendDailyReportQuestions`）を**一度手動で実行**してください。これにより権限承認ダイアログが表示されるので、画面に従ってすべてを「許可」します。

### 2. GCPとGASの連携設定

#### 問題2-1: 「応答がありません」エラーが解決しない

*   **原因A: GASウェブアプリのアクセス権限**
    *   **解説**: GASウェブアプリのデプロイ設定で、「アクセスできるユーザー」が**`全員`**になっていないと、Google ChatのサーバーがGASを呼び出せず、タイムアウトします。
    *   **対策**: 必ず「アクセスできるユーザー」を`全員`に設定してデプロイしてください。

*   **原因B: デプロイURLの不一致**
    *   **解説**: GASはコードを修正して**「新しいデプロイ」を作成するたびに、ウェブアプリのURLが新しくなります。** 古いURLのままでは連携は失敗します。
    *   **対策**: デプロイの都度、新しいURLをコピーし、GCPのGoogle Chat API設定画面にある「アプリのURL」に貼り付け直してください。

*   **原因C: GCPプロジェクトの紐付けミス**
    *   **解説**: GASが、Chat APIを有効化したGCPプロジェクトや、サービスアカウントを発行したGCPプロジェクトと、正しく紐付いていないと、すべてのAPI呼び出しは失敗します。
    *   **対策**: GASの「プロジェクトの設定」で、正しいGCPプロジェクト番号が設定されているか、必ず確認してください。

### 3. 開発方式の選択

#### 問題3-1: 組織のセキュリティが厳しく、サービスアカウントを追加できない

*   **課題**: Workspace管理設定の変更が許可されず、サービスアカウントをスペースに追加できない。
*   **解決策**: **サービスアカウント方式を諦め、スクリプト実行者自身の権限で動作する方式に切り替えます。**
    *   **認証**: `getGoogleChatAuthToken`関数を、`return ScriptApp.getOAuthToken();` というシンプルなコードに置き換えます。
    *   **マニフェスト**: `appsscript.json`に、必要なOAuthスコープ（例: `"https://www.googleapis.com/auth/chat.messages"`）を明示的に記述します。
    *   **注意点**: この方式では、Botからのメッセージはすべて**あなた（スクリプトの実行者）の名前で投稿されます。**

### 4. トラブルシューティングの基本

*   **API Explorerを使う**: コードが悪いのか、権限が悪いのかを切り分ける最終手段です。Googleの「API Explorer」から直接APIを呼び出してみて、そこでもエラーになるなら、問題はコードではなくアカウントや環境にあります。
*   **ログを徹底的に仕込む**: `Logger.log()`を多用し、「どこまで処理が進んで、どこで失敗しているのか」「どのようなデータを受け取っているのか」を可視化することが、問題解決への一番の近道です。

---