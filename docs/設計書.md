# 日報分析ツール 設計書

## 1. 概要

本ドキュメントは、「日報分析ツール」の内部設計について記述する。主にGASの各関数の役割と処理フローを定義する。

## 2. 全体構成

-   **実行環境**: Google Apps Script
-   **主要言語**: JavaScript (ECMAScript)
-   **データストア**: Googleスプレッドシート（ログ蓄積用）
-   **外部API**: Gemini API, Chatwork API

## 3. 関数設計

### 3.1. トリガー・UI関連

-   `onOpen()`
    -   **役割**: スプレッドシートを開いた際に、カスタムメニューをUIに追加する。
    -   **メニュー項目**:
        -   `日報質問送信（Chatwork）` -> `sendDailyReportQuestions()` を実行
        -   `Chatwork日報取得・分析` -> `processChatworkReplies()` を実行
        -   `定期実行トリガーを設定` -> `createDailyTriggers()` を実行
        -   `全てのトリガーを削除` -> `deleteTriggers()` を実行
        -   `1on1ヒアリング項目生成` -> `generate1on1Topics()` を実行
-   `getScheduledTimes()`
    -   **役割**: スクリプトプロパティから定期実行の時刻を取得する。未設定の場合はデフォルト値を返す。
-   `createDailyTriggers()`
    -   **役割**: 日報質問送信、返信収集、ログクリーンアップの定期実行トリガーを設定する。
    -   **処理フロー**:
        1.  既存のトリガーを `deleteTriggers()` で全て削除する。
        2.  `getScheduledTimes()` で設定された時刻を取得する。
        3.  `sendDailyReportQuestions` の日次トリガーを設定する。
        4.  `processChatworkReplies` の日次トリガーを設定する。
        5.  `cleanUpBotQuestionLog` の週次トリガー（毎週月曜日深夜）を設定する。
-   `deleteTriggers()`
    -   **役割**: このスクリプトで設定された全てのトリガーを削除する。

### 3.2. ログ管理関連

-   `cleanUpBotQuestionLog()`
    -   **役割**: `BOT質問ログ` シートをクリーンアップする。
    -   **処理フロー**:
        1.  `返信済み_処理成功` のレコードを削除。
        2.  7日以上経過した `未返信` レコードを削除。
        3.  7日以上経過した `返信済み_フォーマット不正` または `エラー発生` レコードを削除。
-   `logQuestionMessageId(roomId, messageId, timestamp, status)`
    -   **役割**: 送信した質問メッセージのIDと初期ステータスを「BOT質問ログ」シートに記録する。
-   `getPendingQuestionMessages()`
    -   **役割**: 「BOT質問ログ」シートから全ての質問メッセージ情報を読み込む。
-   `updateQuestionStatus(roomId, messageId, newStatus, errorDetail)`
    -   **役割**: 「BOT質問ログ」シートの質問メッセージのステータスとエラー詳細を更新する。
-   `logReportToSheet(reportData, status, reason)`
    -   **役割**: 分析後の日報データとAI評価を「日報ログ」シートに記録する。

### 3.3. Chatwork連携関連

-   `getChatworkApiKey()` / `getChatworkTargetRoomIds()`
    -   **役割**: スクリプトプロパティからChatwork関連の情報を取得する。
-   `getBotChatworkAccountId()`
    -   **役割**: BOT自身のChatworkアカウントIDを取得する。キャッシュ（スクリプトプロパティ）機構を持つ。
-   `sendDailyReportQuestions()`
    -   **役割**: 全ての部下に日報提出を促す質問を送信する。
    -   **処理フロー**:
        1.  未処理またはロック状態の日報が存在しないかチェックし、存在する場合は送信をスキップする。
        2.  `sendChatworkNotification()` を使って定型メッセージを送信する。
        3.  送信後、返された `message_id` を `logQuestionMessageId()` で記録する。
-   `processChatworkReplies()`
    -   **役割**: Chatworkからの返信を収集し、日報として解析・評価する。
    -   **処理フロー**:
        1.  未処理の質問がない、またはロック状態の質問がある場合は処理をスキップする。
        2.  `getChatworkMessages()` で最新50件のメッセージを取得。
        3.  BOT自身のメッセージを除外し、質問への返信（引用形式）であるかをチェックする。
        4.  返信と識別された場合、`#日報` ハッシュタグの有無で処理を分岐。
        5.  `parseReportFromMessage()` で日報データを抽出し、`validateDailyReport()` で検証。
        6.  検証結果に基づき、成功なら `assessAndNotify()` を呼び出し、失敗ならステータスを `返信済み_フォーマット不正` に更新する。
-   `getChatworkMessages(roomId, count)`
    -   **役割**: Chatwork APIを呼び出し、指定したルームのメッセージを取得する。
-   `sendChatworkNotification(roomId, message)`
    -   **役割**: Chatwork APIを呼び出し、指定したルームにメッセージを送信する汎用関数。

### 3.4. 日報データ処理・分析関連

-   `parseReportFromMessage(name, messageBody)`
    -   **役割**: メッセージ本文を正規表現で解析し、各項目を抽出してオブジェクトとして返す。
-   `validateDailyReport(reportData)`
    -   **役割**: 日報データオブジェクトの必須項目の存在と形式を検証する。
-   `assessAndNotify(reportData)`
    -   **役割**: 日報データを評価し、必要に応じて通知するメインロジック。
    -   **処理フロー**:
        1.  `callGeminiApi()` で日報内容を分析・評価させる。
        2.  評価結果が「危険」または「少し悪い」場合、マネージャーにChatworkで通知する。
        3.  `logReportToSheet()` で結果をスプレッドシートに記録する。

### 3.5. Gemini API関連

-   `getGeminiApiKey()`
    -   **役割**: スクリプトプロパティから `GEMINI_API_KEY` を取得する。
-   `callGeminiApi(prompt)`
    -   **役割**: Gemini APIにプロンプトを送信し、結果を返す。

### 3.6. 1on1ヒアリング項目生成関連

-   `getAllEmployeeNames()`
    -   **役割**: 「日報ログ」シートから全社員のユニークな名前リストを取得する。
-   `getDailyReportDataForEmployee(employeeName, limit)`
    -   **役割**: 指定された社員の過去の日報データを取得する。
-   `truncateText(text, maxLength)`
    -   **役割**: テキストを指定された最大長に切り詰めるユーティリティ。
-   `generate1on1Topics()`
    -   **役割**: 日報ログを分析し、1on1ヒアリング項目を生成する。
    -   **処理フロー**:
        1.  スクリプトプロパティから対象社員名を取得。
        2.  `getDailyReportDataForEmployee()` で日報データを取得。
        3.  日報データを元にプロンプトを生成し、`callGeminiApi()` を呼び出す。
        4.  生成されたヒアリング項目をマネージャーのChatworkに通知する。

---
最終更新日: 2025/07/04