# 日報分析ツール 設計書

## 1. 概要

本ドキュメントは、「日報分析ツール」の内部設計について記述する。主にGASの各関数の役割と処理フローを定義する。

## 2. 全体構成

-   **実行環境**: Google Apps Script
-   **主要言語**: JavaScript (ECMAScript)
-   **データストア**: Googleスプレッドシート（`Chatwork設定`, `日報ログ`, `BOT質問ログ`）
-   **外部API**: Gemini API, Chatwork API

## 3. 関数設計

### 3.1. トリガー・UI関連

-   `onOpen()`
    -   **役割**: スプレッドシートを開いた際に、カスタムメニューをUIに追加する。
-   `createDailyTriggers()` / `deleteTriggers()`
    -   **役割**: 定期実行トリガー（日報質問、返信収集、ログクリーンアップ）の作成と削除を行う。

### 3.2. ログ管理関連

-   `cleanUpBotQuestionLog()`
    -   **役割**: `BOT質問ログ` シートの古いレコードを定期的に削除する。
-   `logQuestionMessageId(...)`
    -   **役割**: 送信した質問メッセージのIDとステータスを`BOT質問ログ`シートに記録する。
-   `getPendingQuestionMessages()`
    -   **役割**: `BOT質問ログ`シートから全ての質問メッセージ情報を読み込む。
-   `updateQuestionStatus(...)`
    -   **役割**: `BOT質問ログ`シートの質問メッセージのステータスを更新する。
-   `logReportToSheet(...)`
    -   **役割**: 分析後の日報データ、AI評価、**担当マネージャー名**を`日報ログ`シートに記録する。

### 3.3. Chatwork連携・設定関連

-   `getChatworkApiKey()`
    -   **役割**: スクリプトプロパティからChatwork APIキーを取得する。
-   `getChatworkTargetRoomIds()`
    -   **役割**: `Chatwork設定`シートから全社員と担当マネージャーの情報を読み込み、フラットなオブジェクト配列を返す。
    -   **返り値**: `{employeeName, employeeRoomId, managerName, managerRoomId}` の配列。
-   `getBotChatworkAccountId()`
    -   **役割**: BOT自身のChatworkアカウントIDを取得する。初回取得時にスクリプトプロパティにキャッシュする。
-   `sendDailyReportQuestions()`
    -   **役割**: `Chatwork設定`シートに登録されている全社員に日報提出を促す質問を送信する。
    -   **処理フロー**:
        1.  `getChatworkTargetRoomIds()` で全社員のリストを取得する。
        2.  各社員について、`BOT質問ログ`を基に未処理の日報が存在しないか確認し、なければ質問を送信する。
-   `processChatworkReplies()`
    -   **役割**: Chatworkからの返信を収集し、日報として解析・評価する。
    -   **処理フロー**:
        1.  `getChatworkTargetRoomIds()` で全社員のリストを取得する。
        2.  各社員のメッセージを取得し、BOTの質問への返信を特定する。
        3.  `parseReportFromMessage()` と `validateDailyReport()` で日報を解析・検証する。
        4.  検証成功後、`assessAndNotify()` を呼び出す。
-   `sendChatworkNotification(...)`
    -   **役割**: Chatwork APIを呼び出し、指定したルームにメッセージを送信する汎用関数。

### 3.4. 日報データ処理・分析関連

-   `parseReportFromMessage(...)`
    -   **役割**: メッセージ本文を正規表現で解析し、日報データを抽出する。
-   `validateDailyReport(reportData)`
    -   **役割**: 日報データの必須項目を検証する。`気分`は`良い`, `普通`, `少し悪い`, `悪い`のいずれかを許容する。
-   `assessAndNotify(reportData, managerName, managerRoomId)`
    -   **役割**: 日報データを評価し、必要に応じて通知するメインロジック。
    -   **処理フロー**:
        1.  `callGeminiApi()` で日報内容を分析・評価させる。
        2.  評価結果が「危険」または「少し悪い」場合、引数で受け取った`managerRoomId`宛に通知する。
        3.  `logReportToSheet()` を呼び出し、結果をスプレッドシートに記録する。

### 3.5. Gemini API関連

-   `getGeminiApiKey()`
    -   **役割**: スクリプトプロパティから `GEMINI_API_KEY` を取得する。
-   `callGeminiApi(prompt)`
    -   **役割**: Gemini APIにプロンプトを送信し、結果を返す。

### 3.6. 1on1ヒアリング項目生成関連

-   `getDailyReportDataForEmployee(...)`
    -   **役割**: 指定された社員の過去1年間の日報データを`日報ログ`シートから取得し、気分傾向、AI評価の推移、繰り返し現れる課題、ポジティブな業務内容などを集約・要約したテキストを生成する。
-   `getSelfEvaluationDataForEmployee(...)`
    -   **役割**: Googleドライブから指定された社員の自己評価シートを読み込み、設問内容、本人コメント、マネージャコメント、自己評価、マネージャ評価などの詳細なデータを抽出する。
-   `generate1on1Topics()`
    -   **役割**: 日報ログの要約と自己評価シートのデータを分析し、1on1ヒアリング項目を生成する。
    -   **処理フロー**:
        1.  スクリプトプロパティから対象社員名、自己評価シートのフォルダID、シート名を取得。
        2.  `getChatworkTargetRoomIds()`で対象社員の担当マネージャー情報を特定する。
        3.  `getDailyReportDataForEmployee()` で日報ログの要約を取得。
        4.  `getSelfEvaluationDataForEmployee()` で自己評価データを取得。
        5.  日報ログの要約と自己評価データを基にプロンプトを生成。
        6.  `callGeminiApi()` を呼び出してヒアリング項目を取得し、担当マネージャーのChatworkに整形して結果を通知する。この際、Gemini APIからの応答に含まれるMarkdown記号や顔文字はそのまま表示される。

---
最終更新日: 2025/07/07
