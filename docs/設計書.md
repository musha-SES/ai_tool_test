# 日報分析ツール 設計書

## 1. 概要

本ドキュメントは、「日報分析ツール」の内部設計について記述する。主にGASの各関数の役割と処理フローを定義する。

## 2. 全体構成

-   **実行環境**: Google Apps Script
-   **主要言語**: JavaScript
-   **データストア**: Googleスプレッドシート（ログ蓄積用）
-   **外部API**: Gemini API, Chatwork API

## 3. 関数設計

### 3.1. トリガー・UI関連

-   `onOpen()`
    -   **役割**: スプレッドシートを開いた際に、カスタムメニューをUIに追加する。
    -   **メニュー項目**:
        -   `日報質問送信（Chatwork）` -> `sendDailyReportQuestions()` を実行
        -   `Chatwork日報取得・分析` -> `processChatworkReplies()` を実行
        -   `定期実行トリガーを設定` -> `createDailyTriggers()` を実行
        -   `全てのトリガーを削除` -> `deleteTriggers()` を実行
        -   `自己評価シート分析` -> `processSelfEvaluationSheets()` を実行
        -   `1on1ヒアリング項目生成` -> `generate1on1Topics()` を実行
-   `createDailyTriggers()`
    -   **役割**: 日報質問送信、返信収集、ログクリーンアップの定期実行トリガーを設定する。
    -   **処理フロー**:
        1.  既存のトリガーを `deleteTriggers()` で全て削除する。
        2.  `getScheduledTimes()` で設定された時刻を取得する。
        3.  `sendDailyReportQuestions` の日次トリガーを設定する。
        4.  `processChatworkReplies` の日次トリガーを設定する。
        5.  `cleanUpBotQuestionLog` の週次トリガー（毎週月曜日深夜）を設定する。
-   `deleteTriggers()`
    -   **役割**: このスクリプトで設定された全てのトリガーを削除する。
    -   **処理フロー**:
        1.  `ScriptApp.getProjectTriggers()` でプロジェクトの全トリガーを取得する。
        2.  取得したトリガーをループ処理で一つずつ削除する。


### 3.2. Chatwork連携関連

-   `getChatworkApiKey()`
    -   **役割**: スクリプトプロパティから `CHATWORK_API_KEY` を取得して返す。
-   `getChatworkTargetRoomIds()`
    -   **役割**: スクリプトプロパティから `CHATWORK_ROOM_IDS` をJSONとして取得・パースして返す。
-   `sendDailyReportQuestions()`
    -   **役割**: 全ての部下に日報提出を促す質問を送信する。
    -   **処理フロー**:
        1.  `getChatworkTargetRoomIds()` で全ルームIDを取得。
        2.  **`getPendingQuestionMessages()` で未処理の質問メッセージIDを取得し、重複送信を防止する。**
        3.  ループ処理で、マネージャー以外の各メンバーのルームIDに対し、**未処理またはロック状態の日報が存在しない場合のみ**以下を実行。
        4.  `sendChatworkNotification()` を使って定型メッセージを送信する。
        5.  送信後、返された `message_id` と初期ステータス（`未返信`）を `logQuestionMessageId()` で「BOT質問ログ」シートに記録する。
-   `processChatworkReplies()`
    -   **役割**: Chatworkからの返信を収集し、日報として解析・評価する。
    -   **処理フロー**:
        1.  `getChatworkTargetRoomIds()` で全ルームIDを取得。
        2.  `getBotChatworkAccountId()` でBOT自身のアカウントIDを取得。
        3.  `getPendingQuestionMessages()` で「BOT質問ログ」シートから未処理の質問メッセージIDを取得。
        4.  ループ処理で、各メンバーのルームに対し以下を実行。
        5.  **`BOT質問ログ` シートに記録されている質問メッセージIDが、`返信済み_フォーマット不正`、`エラー発生`ステータスである場合、その質問に関する返信の処理を完全にスキップする。**
        6.  `getChatworkMessages()` で最新50件のメッセージを取得。
        7.  取得したメッセージの中から、BOT自身が送信したメッセージを除外する。
        8.  メッセージが、未処理の質問メッセージIDへの「返信」（引用形式）であるかをチェックする。
        9.  返信と識別された場合、日報フォーマットのチェック（`#日報` ハッシュタグを含む）と `parseReportFromMessage()` で日報データを抽出。
        10. `validateDailyReport()` で日報データをバリデーション。
        11. バリデーション結果に基づき処理を分岐。
            -   **有効な場合**: `assessAndNotify()` を呼び出し、分析・通知・ログ記録処理に渡す。**処理後、`updateQuestionStatus()` で「BOT質問ログ」シートのステータスを「`返信済み_処理成功`」に更新する。**
            -   **無効な場合**: ログに詳細を出力。後続処理はスキップ。**`updateQuestionStatus()` で「BOT質問ログ」シートのステータスを「`返信済み_フォーマット不正`」に更新する。**
        12. **日報処理中にエラーが発生した場合、`updateQuestionStatus()` で「BOT質問ログ」シートのステータスを「`エラー発生_API`」または「`エラー発生_その他`」に更新し、エラー詳細も記録する。**
-   `getChatworkMessages(roomId, count)`
    -   **役割**: Chatwork API (`/rooms/{room_id}/messages`) を呼び出し、指定したルームのメッセージを取得する。取得件数を50件に増加。
-   `findLatestDailyReportReply(messages)`
    -   **役割**: メッセージ配列の中から、キーワード（`業務内容：`等）と `#日報` ハッシュタグを含む最新のものを日報として返す。
-   `parseReportFromMessage(name, messageBody)`
    -   **役割**: メッセージ本文を正規表現で解析し、各項目（業務内容、気分、困っていること）を抽出して `reportData` オブジェクトとして返す。コロンの後のスペースや改行の有無に関わらず内容を抽出し、項目が存在しない場合は `N/A` や `特になし` を返す。
-   `validateDailyReport(reportData)`
    -   **役割**: 日報データオブジェクトの必須項目（氏名、業務内容、気分）の存在と形式を検証する。
    -   **バリデーションルール**: 
        -   `name`: 空でないこと。
        -   `workContent`: 空でないこと、かつ空白のみでないこと。
        -   `mood`: 空でないこと、かつ `良い`, `普通`, `悪い` のいずれかであること。不正な値が入力された場合は、その旨を明確にメッセージに含める。
    -   **戻り値**: `{ isValid: boolean, message: string }` 形式で結果を返す。
-   `sendChatworkNotification(roomId, message)`
    -   **役割**: Chatwork API (`/rooms/{room_id}/messages`) を呼び出し、指定したルームにメッセージを送信する汎用関数。送信したメッセージの `message_id` を含むレスポンスを返す。
-   `getBotChatworkAccountId()`
    -   **役割**: BOT自身（APIトークン所有者）のChatworkアカウントIDを取得する。スクリプトプロパティに保存されていればそこから読み込み、なければChatwork APIを呼び出して取得し、スクリプトプロパティに保存する。
-   `setChatworkBotAccountId(accountId)`
    -   **役割**: BOTアカウントIDをスクリプトプロパティに保存するヘルパー関数。
-   `logQuestionMessageId(roomId, messageId, timestamp, status)`
    -   **役割**: 送信した質問メッセージのIDと初期ステータスを「BOT質問ログ」シートに記録する。
-   `getPendingQuestionMessages()`
    -   **役割**: 「BOT質問ログ」シートから未処理の質問メッセージIDとステータスを読み込む。
-   `updateQuestionStatus(roomId, messageId, newStatus, errorDetail)`
    -   **役割**: 「BOT質問ログ」シートの質問メッセージのステータスとエラー詳細を更新する。



### 3.4. 1on1ヒアリング項目生成関連

-   `generate1on1Topics()`
    -   **役割**: 日報ログを分析し、1on1ヒアリング項目を生成する。対象の社員はスクリプトプロパティから読み込む。
    -   **処理フロー**:
        1.  スクリプトプロパティ `TARGET_EMPLOYEE_NAME_FOR_1ON1` から対象の社員名を取得する。
        2.  プロパティが未設定の場合、エラーメッセージをログに出力し、処理を中断する。
        3.  `getDailyReportDataForEmployee()` で対象社員の直近の日報データを取得する。
        4.  日報データがない場合、情報メッセージをログに出力し、処理を中断する。
        5.  日報データを `truncateText()` を用いて一定の長さに切り詰める。
        6.  匿名化したプロンプトを構築し、Geminiに送信する（現在はダミーデータを生成）。
        7.  生成されたヒアリング項目を `sendChatworkNotification()` でマネージャーのChatworkに通知する。
-   `getDailyReportDataForEmployee(employeeName, limit)`
    -   **役割**: 指定された社員の過去の日報データを取得する。直近の指定件数（デフォルト5件）の日報を返す。
    -   **戻り値**: `workContent`（業務内容）、`problems`（困っていること）、`aiReason`（AI評価理由）をキーに持つオブジェクトの配列。

### 3.5. ユーティリティ関数

-   `truncateText(text, maxLength)`
    -   **役割**: テキストを指定された最大長に切り詰め、末尾に「...」を追加する。`generate1on1Topics` 内でプロンプトが長くなりすぎるのを防ぐために使用される。
    -   **処理フロー**:
        1.  入力テキストが文字列でない場合、空文字列を返す。
        2.  テキスト長が最大長を超える場合、指定長で切り詰めて末尾に "..." を付与して返す。
        3.  テキスト長が最大長以下の場合、そのまま返す。

