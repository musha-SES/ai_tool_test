# 日報分析ツール 設計書

## 1. 概要

本ドキュメントは、「日報分析ツール」の内部設計について記述する。主にGoogle Apps Script (GAS) の各関数の役割、処理フロー、データ構造、依存関係を定義する。

## 2. 全体構成

-   **実行環境**: Google Apps Script
-   **主要言語**: JavaScript (ECMAScript)
-   **データストア**: Googleスプレッドシート
-   **外部API**: Gemini API, Chatwork API
-   **設定管理**:
    -   **`CONFIG`オブジェクト**: コード冒頭で定義される定数オブジェクト。シート名、キーワード、APIモデル名、ヘッダー名など、変更の可能性があるが秘匿情報ではない設定値を一元管理する。これにより、仕様変更時のメンテナンス性を向上させる。
    -   **スクリプトプロパティ**: GASのプロジェクト設定機能。APIキーなどの秘匿情報や、環境ごとに異なる可能性がある設定（1on1対象者名など）を管理する。

## 3. 関数設計

`Main.gs`に実装されている各関数の詳細設計を以下に示す。

### 4.1. 設定管理

-   **`CONFIG` (定数オブジェクト)**
    -   **役割**: アプリケーション全体で使用する設定値を一元的に管理する。ハードコーディングを避け、保守性を高めることが目的。
    -   **主なキー**:
        -   `BOT_QUESTION_LOG_SHEET_NAME`: BOTの質問履歴を記録するシート名。
        -   `DAILY_REPORT_LOG_SHEET_NAME`: 全ての日報とAI評価結果を記録するシート名。
        -   `CHATWORK_SETTINGS_SHEET_NAME`: ユーザー情報を管理するシート名。
        -   `DAILY_REPORT_LOG_FETCH_DAYS_FOR_1ON1`: 1on1トピック生成時に遡る日報ログの日数。
        -   `MOOD_OPTIONS`: 日報で許容される「気分」の選択肢（良い、普通、少し悪い、悪い）。バリデーションに使用。
        -   `PROBLEM_KEYWORDS`: 1on1トピック生成時に日報からキーワード出現回数を集計するためのキーワード群。
        -   `CHATWORK_SETTINGS_HEADERS`: `Chatwork設定`シートの必須ヘッダー名。
        -   `GEMINI_MODEL_NAME`: 使用するGemini APIのモデル名。
        -   `SCHEDULE_DEFAULTS`: 定期実行トリガーのデフォルト時刻。
        -   `WEEKLY_REPORT_FETCH_DAYS`: 週次レポート生成時に遡る日報ログの日数。
        -   `REPRESENTATIVE_REPORTS_COUNT`: 1on1トピック生成時に抜粋する代表日報の最大件数。
        -   `POSITIVE_KEYWORDS`: 日報からポジティブな活動を抽出するためのキーワード群。
        -   `SELF_EVALUATION_DEFAULT_NAME_HEADER`: 自己評価シートの氏名列のデフォルトヘッダー名。
        -   `SELF_EVAL_FILENAME_KEYWORD`: 自己評価シートのファイル名に含まれるキーワード。
        -   `SELF_EVAL_PERIOD_HEADER`: 自己評価シートの評価期間列のヘッダー名。
        -   `SELF_EVAL_SINGLE_ITEM_HEADERS`: 自己評価シートの単一項目ヘッダー。
        -   `SELF_EVAL_QUESTION_SUFFIXES`: 自己評価シートの設問関連列のサフィックス。
        -   `COMMON_PROBLEMS_MIN_COUNT`: 共通課題として認識する最小出現回数。
        -   `COMMON_PROBLEMS_MAX_DISPLAY`: 共通課題の最大表示数。
        -   `DEFAULT_WEEKLY_REPORT_MODE`: 週次レポートモードのデフォルト値。
        -   `WEEKLY_REPORT_MODES`: 週次レポートモードの選択肢。

### 4.2. トリガー・UI関連

-   **`onOpen()`**
    -   **役割**: スプレッドシートを開いた際に、カスタムメニュー `日報AIツール` をUI上に追加する。`週次レポート生成`メニュー項目も追加される。
-   **`getScheduledTimes()`**
    -   **役割**: スクリプトプロパティから定期実行の時刻設定を読み込む。プロパティが存在しない場合は`CONFIG.SCHEDULE_DEFAULTS`のデフォルト値を使用する。
-   **`createDailyTriggers()`**
    -   **役割**: 既存のトリガーを全て削除した後、`sendDailyReportQuestions`, `processChatworkReplies`, `cleanUpBotQuestionLog`, `generateWeeklyReports`の4つの関数に対して、時間ベースのトリガーを新規に設定する。
-   **`deleteTriggers()`**
    -   **役割**: 現在のプロジェクトに設定されている全てのトリガーを削除する。

### 4.3. ログ管理関連

-   **`cleanUpBotQuestionLog()`**
    -   **役割**: `BOT質問ログ`シートの古いログを削除する。7日以上経過した「未返信」「エラー」ログと、正常に処理が完了した「返信済み_処理成功」ログを削除対象とする。
-   **`logQuestionMessageId(...)`**
    -   **役割**: Chatworkに送信した質問メッセージの情報を`BOT質問ログ`シートに追記する。
-   **`getPendingQuestionMessages()`**
    -   **役割**: `BOT質問ログ`シートから全てのログを読み込み、処理しやすいオブジェクトの配列に変換して返す。
-   **`updateQuestionStatus(...)`**
    -   **役割**: `BOT質問ログ`シート内の特定のメッセージIDのステータス（とエラー詳細）を更新する。
-   **`logReportToSheet(...)`**
    -   **役割**: 解析・評価が完了した日報データを`日報ログ`シートに追記する。

### 4.4. Chatwork連携

-   **`getChatworkApiKey()`**: スクリプトプロパティからChatwork APIキーを取得する。
-   **`getChatworkTargetRoomIds()`**
    -   **役割**: `Chatwork設定`シートを読み込み、マネージャーと社員の情報を紐付けた、フラットな社員情報リストを生成する。
    -   **処理フロー**:
        1. シートから全データを取得。
        2. データをループし、役割が`manager`のユーザーと`employee`のユーザーをそれぞれ別の配列に格納。
        3. `employee`のリストをループし、`グループ名`をキーにして対応する`manager`情報を紐付ける。
        4. 最終的な `{employeeName, employeeRoomId, managerName, managerRoomId, weeklyReportMode, group, role}` の配列を返す。`weeklyReportMode`はマネージャーの設定が引き継がれる。
-   **`getBotChatworkAccountId()`**: Chatwork APIの`/me`エンドポイントを叩き、BOT自身のChatworkアカウントIDを取得する。取得したIDはスクリプトプロパティにキャッシュする。
-   **`sendDailyReportQuestions()`**: `getChatworkTargetRoomIds()`で取得した全社員に対し、未処理の日報がないか確認した上で、日報提出を促すメッセージを送信する。
-   **`processChatworkReplies()`**: 未処理の質問がある社員のルームを対象に、Chatworkからメッセージを取得し、日報の返信を解析・処理する。
-   **`getChatworkMessages(...)`**: Chatwork APIを呼び出し、指定されたルームのメッセージを取得する。
-   **`sendChatworkNotification(...)`**: Chatwork APIを呼び出し、指定されたルームにメッセージを送信する汎用関数。

### 4.5. 日報データ処理・分析

-   **`parseReportFromMessage(...)`**: Chatworkのメッセージ本文から、正規表現を用いて「業務内容」「気分」「困っていること」を抽出する。
-   **`validateDailyReport(reportData)`**: 抽出した日報データが正しいフォーマットか（必須項目が埋まっているか、気分が選択肢内か）を検証する。
-   **`assessAndNotify(...)`**: 日報データをGemini APIで評価し、結果に応じてマネージャーに通知し、ログを記録する一連の処理を統括する。

### 4.6. Gemini API関連

-   **`getGeminiApiKey()`**: スクリプトプロパティからGemini APIキーを取得する。
-   **`callGeminiApi(prompt)`**: Gemini APIの`generateContent`エンドポイントに対し、指定されたプロンプトを送信し、応答テキストを返す。

### 4.7. 1on1ヒアリング項目生成

-   **`getDailyReportDataForEmployee(...)`**
    -   **役割**: `日報ログ`シートから特定社員の過去のデータを抽出し、1on1のためのサマリーを生成する。
    -   **処理フロー**:
        1. 対象社員の日報を`CONFIG.DAILY_REPORT_LOG_FETCH_DAYS_FOR_1ON1`で指定された期間分抽出。
        2. 気分の回数、`CONFIG.PROBLEM_KEYWORDS`の出現回数などを集計。
        3. AI評価が「危険」または「少し悪い」の日報を優先的に収集し、代表的な日報として抜粋する。
        4. その他の日報から、月ごとにランダムに選択し、代表的な日報として抜粋する（最大件数は`CONFIG.REPRESENTATIVE_REPORTS_COUNT`で設定）。
        5. ポジティブな活動（新規機能リリース、顧客高評価、業務改善、目標達成など）を`CONFIG.POSITIVE_KEYWORDS`に基づいて集計する。
        6. 上記を組み合わせたハイブリッドな要約テキストを生成して返す。
-   **`getSelfEvaluationDataForEmployee(...)`**
    -   **役割**: Googleドライブの指定フォルダから特定社員の自己評価シート（スプレッドシート）を検索し、その内容を解析してオブジェクトとして返す。
    -   **処理フロー**:
        1. フォルダ内のファイルを検索し、ファイル名から対象シートを特定。
        2. シートのヘッダーとデータ行を読み込む。
        3. ヘッダー名に基づいて、各評価項目、コメント、目標などを抽出、構造化されたオブジェクトを生成する。
-   **`generate1on1Topics()`**
    -   **役割**: 日報ログと自己評価シートのデータを基に、1on1のヒアリング項目を生成し、Chatworkに通知する。
    -   **処理フロー**:
        1. `getDailyReportDataForEmployee`と`getSelfEvaluationDataForEmployee`でデータを収集。
        2. 収集したデータを埋め込んだ、**厳密な応答フォーマットを指定するテンプレート**を使い、Gemini APIへのプロンプトを生成。
        3. `callGeminiApi`を呼び出す。
        4. 応答テキストを正規表現で解析し、**質問と根拠のペアを抽出**する。
        5. 抽出した内容を整形し、担当マネージャーに通知する。

### 4.8. 週次レポート生成機能

-   **`generateWeeklyReports()`**
    -   **役割**: 週次レポートの生成と通知を統括するメイン関数。
    -   **処理フロー**:
        1. `getChatworkTargetRoomIds()` を呼び出し、全社員の情報を取得する。
        2. マネージャーのルームIDをキーとして、担当社員、グループ名、週次レポートモード（`individual`/`team`）を含むオブジェクトを構築し、マネージャーごとにグループ化する。
        3. マネージャーのグループごとにループ処理を行う。
        4. 各マネージャーの`weeklyReportMode`に応じて、`individual`モードまたは`team`モードの処理を呼び出す。
        5. **`individual`モードの場合**:
            - 担当社員ごとにループし、`getWeeklyRawReports()`で過去1週間分の日報データを取得。取得した生データは`generateIndividualReportWithGemini()`に渡され、整形されたレポートがマネージャー向けの単一のメッセージボディに追記される。
            - 全社員のレポートを結合した後、最終的なレポートをマネージャーに通知する。
        6. **`team`モードの場合**:
            - 担当社員のリストを`getWeeklyTeamReportSummaryForGroup()`に渡し、チーム全体のデータを集計。
            - 集計データを`generateTeamSummaryReportWithGemini()`に渡し、Gemini APIでサマリーを生成。
            - 生成されたサマリーを`【週次チームコンディションサマリー】`としてマネージャーに通知する。

-   **`getWeeklyRawReports(employeeName)`**
    -   **役割**: `日報ログ`シートから、指定された社員1名分の過去1週間分の日報データを抽出し、オブジェクトの配列として返す。フィルタリングには`タイムスタンプ`列を使用する。

-   **`getWeeklyTeamReportSummaryForGroup(employeeNames)`**
    -   **役割**: `日報ログ`シートから、指定された社員リスト（複数名）に該当する過去1週間分の日報データを全て抽出し、チーム全体の傾向（気分、課題、ポジティブな動き）を集計して返す。フィルタリングには`タイムスタンプ`列を使用する。

-   **`generateTeamSummaryReportWithGemini(summaryData, groupName)`**
    -   **役割**: 集計されたチーム日報データとグループ名を基に、Gemini APIを呼び出して週次チームコンディションサマリーレポートを生成する。

---
最終更新日: 2025/07/23