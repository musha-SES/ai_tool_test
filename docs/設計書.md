# 日報分析ツール 設計書

## 1. 概要

本ドキュメントは、「日報分析ツール」の内部設計について記述する。主にGoogle Apps Script (GAS) の各関数の役割、処理フロー、データ構造、依存関係を定義する。

## 2. 全体構成

-   **実行環境**: Google Apps Script
-   **主要言語**: JavaScript (ECMAScript)
-   **データストア**: Googleスプレッドシート
-   **外部API**: Gemini API, Chatwork API
-   **設定管理**:
    -   **`CONFIG`オブジェクト**: コード冒頭で定義される定数オブジェクト。シート名、キーワード、APIモデル名、ヘッダー名など、変更の可能性があるが秘匿情報ではない設定値を一元管理する。これにより、仕様変更時のメンテナンス性を向上させる。
    -   **スクリプトプロパティ**: GASのプロジェクト設定機能。APIキーなどの秘匿情報や、環境ごとに異なる可能性がある設定（1on1対象者名など）を管理する。

## 3. 関数設計

`nippou_tool.gs`に実装されている各関数の詳細設計を以下に示す。

### 4.1. 設定管理

-   **`CONFIG` (定数オブジェクト)**
    -   **役割**: アプリケーション全体で使用する設定値を一元的に管理する。ハードコーディングを避け、保守性を高めることが目的。
    -   **主なキー**:
        -   `BOT_QUESTION_LOG_SHEET_NAME`: BOTの質問履歴を記録するシート名。
        -   `DAILY_REPORT_LOG_SHEET_NAME`: 全ての日報とAI評価結果を記録するシート名。
        -   `CHATWORK_SETTINGS_SHEET_NAME`: ユーザー情報を管理するシート名。
        -   `DAILY_REPORT_LOG_FETCH_DAYS`: 1on1トピック生成時に遡る日報ログの日数。
        -   `MOOD_OPTIONS`: 日報で許容される「気分」の選択肢。バリデーションに使用。
        -   `PROBLEM_KEYWORDS`: 1on1トピック生成時に日報からキーワード出現回数を集計するためのキーワード群。
        -   `CHATWORK_SETTINGS_HEADERS`: `Chatwork設定`シートの必須ヘッダー名。
        -   `GEMINI_MODEL_NAME`: 使用するGemini APIのモデル名。
        -   `SCHEDULE_DEFAULTS`: 定期実行トリガーのデフォルト時刻。

### 4.2. トリガー・UI関連

-   **`onOpen()`**
    -   **役割**: スプレッドシートを開いた際に、カスタムメニュー `日報AIツール` をUI上に追加する。`週次チームコンディションサマリー生成`メニュー項目も追加される。
-   **`getScheduledTimes()`**
    -   **役割**: スクリプトプロパティから定期実行の時刻設定を読み込む。プロパティが存在しない場合は`CONFIG.SCHEDULE_DEFAULTS`のデフォルト値を使用する。
-   **`createDailyTriggers()`**
    -   **役割**: 既存のトリガーを全て削除した後、`sendDailyReportQuestions`, `processChatworkReplies`, `cleanUpBotQuestionLog`, `generateWeeklyTeamSummary`の4つの関数に対して、時間ベースのトリガーを新規に設定する。
-   **`deleteTriggers()`**
    -   **役割**: 現在のプロジェクトに設定されている全てのトリガーを削除する。

### 4.3. ログ管理関連

-   **`cleanUpBotQuestionLog()`**
    -   **役割**: `BOT質問ログ`シートの古いログを削除する。7日以上経過した「未返信」「エラー」ログと、正常に処理が完了した「返信済み_処理成功」ログを削除対象とする。
-   **`logQuestionMessageId(...)`**
    -   **役割**: Chatworkに送信した質問メッセージの情報を`BOT質問ログ`シートに追記する。
-   **`getPendingQuestionMessages()`**
    -   **役割**: `BOT質問ログ`シートから全てのログを読み込み、処理しやすいオブジェクトの配列に変換して返す。
-   **`updateQuestionStatus(...)`**
    -   **役割**: `BOT質問ログ`シート内の特定のメッセージIDのステータス（とエラー詳細）を更新する。
-   **`logReportToSheet(...)`**
    -   **役割**: 解析・評価が完了した日報データを`日報ログ`シートに追記する。

### 4.4. Chatwork連携

-   **`getChatworkApiKey()`**: スクリプトプロパティからChatwork APIキーを取得する。
-   **`getChatworkTargetRoomIds()`**
    -   **役割**: `Chatwork設定`シートを読み込み、マネージャーと社員の情報を紐付けた、フラットな社員情報リストを生成する。
    -   **処理フロー**:
        1. シートから全データを取得。
        2. データをループし、役割が`manager`のユーザーと`employee`のユーザーをそれぞれ別の配列に格納。
        3. `employee`のリストをループし、`グループ名`をキーにして対応する`manager`情報を紐付ける。
        4. 最終的な `{employeeName, employeeRoomId, managerName, managerRoomId}` の配列を返す。
-   **`getBotChatworkAccountId()`**: Chatwork APIの`/me`エンドポイントを叩き、BOT自身のChatworkアカウントIDを取得する。取得したIDはスクリプトプロパティにキャッシュする。
-   **`sendDailyReportQuestions()`**: `getChatworkTargetRoomIds()`で取得した全社員に対し、未処理の日報がないか確認した上で、日報提出を促すメッセージを送信する。
-   **`processChatworkReplies()`**: 未処理の質問がある社員のルームを対象に、Chatworkからメッセージを取得し、日報の返信を解析・処理する。
-   **`getChatworkMessages(...)`**: Chatwork APIを呼び出し、指定されたルームのメッセージを取得する。
-   **`sendChatworkNotification(...)`**: Chatwork APIを呼び出し、指定されたルームにメッセージを送信する汎用関数。

### 4.5. 日報データ処理・分析

-   **`parseReportFromMessage(...)`**: Chatworkのメッセージ本文から、正規表現を用いて「業務内容」「気分」「困っていること」を抽出する。
-   **`validateDailyReport(reportData)`**: 抽出した日報データが正しいフォーマットか（必須項目が埋まっているか、気分が選択肢内か）を検証する。
-   **`assessAndNotify(...)`**: 日報データをGemini APIで評価し、結果に応じてマネージャーに通知し、ログを記録する一連の処理を統括する。

### 4.6. Gemini API関連

-   **`getGeminiApiKey()`**: スクリプトプロパティからGemini APIキーを取得する。
-   **`callGeminiApi(prompt)`**: Gemini APIの`generateContent`エンドポイントに対し、指定されたプロンプトを送信し、応答テキストを返す。

### 4.7. 1on1ヒアリング項目生成

-   **`getDailyReportDataForEmployee(...)`**
    -   **役割**: `日報ログ`シートから特定社員の過去のデータを抽出し、1on1のためのサマリーを生成する。
    -   **処理フロー**:
        1. 対象社員の日報を`CONFIG.DAILY_REPORT_LOG_FETCH_DAYS`で指定された期間分抽出。
        2. 気分の回数、`CONFIG.PROBLEM_KEYWORDS`の出現回数などを集計。
        3. AI評価が悪い日報や、月ごとの代表的な日報をいくつか抜粋。
        4. 上記を組み合わせたハイブリッドな要約テキストを生成して返す。
-   **`getSelfEvaluationDataForEmployee(...)`**
    -   **役割**: Googleドライブの指定フォルダから特定社員の自己評価シート（スプレッドシート）を検索し、その内容を解析してオブジェクトとして返す。
    -   **処理フロー**:
        1. フォルダ内のファイルを検索し、ファイル名から対象シートを特定。
        2. シートのヘッダーとデータ行を読み込む。
        3. ヘッダー名に基づいて、各評価項目、コメント、目標などを抽出し、構造化されたオブジェクトを生成する。
-   **`generate1on1Topics()`**
    -   **役割**: 日報ログと自己評価シートのデータを基に、1on1のヒアリング項目を生成し、Chatworkに通知する。
    -   **処理フロー**:
        1. `getDailyReportDataForEmployee`と`getSelfEvaluationDataForEmployee`でデータを収集。
        2. 収集したデータを埋め込んだ、**厳密な応答フォーマットを指定するテンプレート**を使い、Gemini APIへのプロンプトを生成。
        3. `callGeminiApi`を呼び出す。
        4. 応答テキストを正規表現で解析し、**質問と根拠のペアを抽出**する。
        5. 抽出した内容を整形し、担当マネージャーに通知する。

### 4.8. 週次チームコンディションサマリー機能

-   **`generateWeeklyTeamSummary()`**
    -   **役割**: 週次チームコンディションサマリーの生成とマネージャーへの通知を統括するメイン関数。
    -   **処理フロー**:
        1. `getWeeklyTeamReportSummary()` を呼び出し、過去1週間分の日報データを集計する。
        2. 集計データが存在しない場合は処理を終了する。
        3. `generateTeamSummaryReportWithGemini()` を呼び出し、Gemini APIでサマリーレポートを生成する。
        4. `getManagersFromChatworkSettings()` を呼び出し、通知対象のマネージャーリストを取得する。
        5. 各マネージャーのChatworkルームに、生成されたサマリーレポートを通知する。
        6. 各ステップでエラーハンドリングとログ出力を行う。

-   **`getManagersFromChatworkSettings()`**
    -   **役割**: `Chatwork設定`シートから`manager`ロールを持つユーザーの氏名とルームIDを取得する。
    -   **処理フロー**:
        1. `Chatwork設定`シートを読み込む。
        2. ヘッダー情報を解析し、必要な列のインデックスを取得する。
        3. データ行をループし、`役割`が`manager`である行を抽出する。
        4. 抽出したマネージャーの氏名とルームIDの配列を返す。

-   **`getWeeklyTeamReportSummary()`**
    -   **役割**: `日報ログ`シートから過去1週間分の全メンバーの日報データを読み込み、チーム全体のコンディションに関する情報を集計する。
    -   **処理フロー**:
        1. `日報ログ`シートから全データを取得する。
        2. 過去1週間以内の日報データのみをフィルタリングする。
        3. フィルタリングされた日報データから、以下の情報を集計する。
            -   気分報告の各カテゴリ（良い、普通、少し悪い、悪い、危険）の出現回数。
            -   「困っていること」欄から、複数回出現する共通のキーワード（2文字以上）を抽出する。
            -   「今日の業務内容」と「今日の気分」から、ポジティブな動きを示すキーワード（例: タスク完了/目標達成、チームワーク/協力、業務改善/効率化）を抽出する。
        4. 集計結果をオブジェクトとして返す。

-   **`generateTeamSummaryReportWithGemini(summaryData)`**
    -   **役割**: 集計されたチーム日報データに基づき、Gemini APIを呼び出して週次チームコンディションサマリーレポートを生成する。
    -   **処理フロー**:
        1. `summaryData`オブジェクトから、気分傾向、共通の課題、ポジティブな動きの情報を整形する。
        2. これらの情報を埋め込んだプロンプトを構築する。プロンプトには、マネージャーが「空気感」を把握しやすい物語形式でのレポート生成を指示し、社員名の匿名化を明記する。
        3. `callGeminiApi()` を呼び出し、Geminiからサマリーレポートのテキストを取得する。
        4. 取得したレポートテキストを返す。

---
最終更新日: 2025/07/15
