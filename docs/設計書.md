# 日報分析ツール 設計書

## 1. 概要

本ドキュメントは、「日報分析ツール」の内部設計について記述する。主にGASの各関数の役割と処理フローを定義する。

## 2. 全体構成

-   **実行環境**: Google Apps Script
-   **主要言語**: JavaScript (ECMAScript)
-   **データストア**: Googleスプレッドシート
-   **外部API**: Gemini API, Chatwork API
-   **設定管理**: コード冒頭の`CONFIG`オブジェクトで、シート名、キーワード、APIモデル名などの定数を一元管理する。APIキーなどの秘匿情報はスクリプトプロパティで管理する。

## 3. 関数設計

### 3.1. 設定管理

-   `CONFIG` (定数オブジェクト)
    -   **役割**: アプリケーション全体で使用する設定値（シート名、ヘッダー名、キーワード、APIモデル名など）を一元的に管理する。

### 3.2. トリガー・UI関連

-   `onOpen()`
-   `createDailyTriggers()` / `deleteTriggers()`

### 3.3. ログ管理関連

-   `cleanUpBotQuestionLog()`
-   `logQuestionMessageId(...)`
-   `getPendingQuestionMessages()`
-   `updateQuestionStatus(...)`
-   `logReportToSheet(...)`

### 3.4. Chatwork連携・設定関連

-   `getChatworkApiKey()`
-   `getChatworkTargetRoomIds()`
-   `getBotChatworkAccountId()`
-   `sendDailyReportQuestions()`
-   `processChatworkReplies()`
-   `sendChatworkNotification(...)`

### 3.5. 日報データ処理・分析関連

-   `parseReportFromMessage(...)`
-   `validateDailyReport(reportData)`
-   `assessAndNotify(reportData, managerName, managerRoomId)`

### 3.6. Gemini API関連

-   `getGeminiApiKey()`
-   `callGeminiApi(prompt)`

### 3.7. 1on1ヒアリング項目生成関連

-   `getDailyReportDataForEmployee(...)`
-   `getSelfEvaluationDataForEmployee(...)`
-   `generate1on1Topics()`
    -   **役割**: 日報ログと自己評価シートのデータを基に、1on1のヒアリング項目を生成し、Chatworkに通知する。
    -   **処理フロー**:
        1.  `CONFIG`とスクリプトプロパティから各種設定値を取得する。
        2.  `getDailyReportDataForEmployee()`と`getSelfEvaluationDataForEmployee()`で対象者のデータを収集・要約する。
        3.  収集したデータと、**厳密な応答フォーマットを指定するテンプレート**を組み合わせて、Gemini APIへのプロンプトを生成する。
        4.  `callGeminiApi()`を呼び出す。
        5.  応答テキストを正規表現で解析し、**質問と根拠のペアを抽出**する。
        6.  抽出した内容を、指定されたシンプルなフォーマットに整形し、担当マネージャーに通知する。この際、根拠の短縮は行わない。

---
最終更新日: 2025/07/11