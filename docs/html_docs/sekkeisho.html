<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日報分析ツール 設計書</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="content">
        <h1>日報分析ツール 設計書</h1>

<h2>1. 概要</h2>

<p>本ドキュメントは、「日報分析ツール」の内部設計について記述する。主にGoogle Apps Script (GAS) の各関数の役割、処理フロー、データ構造、依存関係を定義する。</p>

<h2>2. 全体構成</h2>

<ul>
<li><strong>実行環境</strong>: Google Apps Script</li>
<li><strong>主要言語</strong>: JavaScript (ECMAScript)</li>
<li><strong>データストア</strong>: Googleスプレッドシート</li>
<li><strong>外部API</strong>: Gemini API, Chatwork API</li>
<li><strong>設定管理</strong>:
<ul>
<li><strong><code>CONFIG</code>オブジェクト</strong>: コード冒頭で定義される定数オブジェクト。シート名、キーワード、APIモデル名、ヘッダー名など、変更の可能性があるが秘匿情報ではない設定値を一元管理する。これにより、仕様変更時のメンテナンス性を向上させる。</li>
<li><strong>スクリプトプロパティ</strong>: GASのプロジェクト設定機能。APIキーなどの秘匿情報や、環境ごとに異なる可能性がある設定（1on1対象者名など）を管理する。</li>
</ul>
</li>
</ul>

<h2>3. 関数設計</h2>

<p><code>Main.gs</code>に実装されている各関数の詳細設計を以下に示す。</p>

<h3>4.1. 設定管理</h3>

<h4><code>CONFIG</code> (定数オブジェクト)</h4>
<ul>
<li><strong>役割</strong>: アプリケーション全体で使用する設定値を一元的に管理する。ハードコーディングを避け、保守性を高めることが目的。</li>
</ul>

<table>
<thead>
<tr>
<th>キー</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr><td><code>BOT_QUESTION_LOG_SHEET_NAME</code></td><td>BOTの質問履歴を記録するシート名。</td></tr>
<tr><td><code>DAILY_REPORT_LOG_SHEET_NAME</code></td><td>全ての日報とAI評価結果を記録するシート名。</td></tr>
<tr><td><code>CHATWORK_SETTINGS_SHEET_NAME</code></td><td>ユーザー情報を管理するシート名。</td></tr>
<tr><td><code>DAILY_REPORT_LOG_FETCH_DAYS_FOR_1ON1</code></td><td>1on1トピック生成時に遡る日報ログの日数。</td></tr>
<tr><td><code>MOOD_OPTIONS</code></td><td>日報で許容される「気分」の選択肢（良い、普通、少し悪い、悪い）。バリデーションに使用。</td></tr>
<tr><td><code>PROBLEM_KEYWORDS</code></td><td>1on1トピック生成時に日報からキーワード出現回数を集計するためのキーワード群。</td></tr>
<tr><td><code>CHATWORK_SETTINGS_HEADERS</code></td><td><code>Chatwork設定</code>シートの必須ヘッダー名。</td></tr>
<tr><td><code>GEMINI_MODEL_NAME</code></td><td>使用するGemini APIのモデル名。</td></tr>
<tr><td><code>SCHEDULE_DEFAULTS</code></td><td>定期実行トリガーのデフォルト時刻。</td></tr>
<tr><td><code>WEEKLY_REPORT_FETCH_DAYS</code></td><td>週次レポート生成時に遡る日報ログの日数。</td></tr>
<tr><td><code>REPRESENTATIVE_REPORTS_COUNT</code></td><td>1on1トピック生成時に抜粋する代表日報の最大件数。</td></tr>
<tr><td><code>POSITIVE_KEYWORDS</code></td><td>日報からポジティブな活動を抽出するためのキーワード群。</td></tr>
<tr><td><code>SELF_EVALUATION_DEFAULT_NAME_HEADER</code></td><td>自己評価シートの氏名列のデフォルトヘッダー名。</td></tr>
<tr><td><code>SELF_EVAL_FILENAME_KEYWORD</code></td><td>自己評価シートのファイル名に含まれるキーワード。</td></tr>
<tr><td><code>SELF_EVAL_PERIOD_HEADER</code></td><td>自己評価シートの評価期間列のヘッダー名。</td></tr>
<tr><td><code>SELF_EVAL_SINGLE_ITEM_HEADERS</code></td><td>自己評価シートの単一項目ヘッダー。</td></tr>
<tr><td><code>SELF_EVAL_QUESTION_SUFFIXES</code></td><td>自己評価シートの設問関連列のサフィックス。</td></tr>
<tr><td><code>COMMON_PROBLEMS_MIN_COUNT</code></td><td>共通課題として認識する最小出現回数。</td></tr>
<tr><td><code>COMMON_PROBLEMS_MAX_DISPLAY</code></td><td>共通課題の最大表示数。</td></tr>
<tr><td><code>DEFAULT_WEEKLY_REPORT_MODE</code></td><td>週次レポートモードのデフォルト値。</td></tr>
<tr><td><code>WEEKLY_REPORT_MODES</code></td><td>週次レポートモードの選択肢。</td></tr>
</tbody>
</table>

<h3>4.2. トリガー・UI関連</h3>

<ul>
<li><strong><code>onOpen()</code></strong>
<ul>
<li><strong>役割</strong>: スプレッドシートを開いた際に、カスタムメニュー <code>日報AIツール</code> をUI上に追加する。<code>週次レポート生成</code>メニュー項目も追加される。</li>
</ul>
</li>
<li><strong><code>getScheduledTimes()</code></strong>
<ul>
<li><strong>役割</strong>: スクリプトプロパティから定期実行の時刻設定を読み込む。プロパティが存在しない場合は<code>CONFIG.SCHEDULE_DEFAULTS</code>のデフォルト値を使用する。</li>
</ul>
</li>
<li><strong><code>createDailyTriggers()</code></strong>
<ul>
<li><strong>役割</strong>: 既存のトリガーを全て削除した後、<code>sendDailyReportQuestions</code>, <code>processChatworkReplies</code>, <code>cleanUpBotQuestionLog</code>, <code>generateWeeklyReports</code>の4つの関数に対して、時間ベースのトリガーを新規に設定する。
注: Apps Scriptの時限トリガーは、指定時刻の前後15分程度の範囲で実行される可能性があり、厳密な時刻の実行は保証されない（Googleのサーバー負荷による）。</li>
</ul>
</li>
<li><strong><code>deleteTriggers()</code></strong>
<ul>
<li><strong>役割</strong>: 現在のプロジェクトに設定されている全てのトリガーを削除する。</li>
</ul>
</li>
</ul>

<h3>4.3. ログ管理関連</h3>

<ul>
<li><strong><code>cleanUpBotQuestionLog()</code></strong>
<ul>
<li><strong>役割</strong>: <code>BOT質問ログ</code>シートの古いログを削除する。7日以上経過した「未返信」「エラー」ログと、正常に処理が完了した「返信済み_処理成功」ログを削除対象とする。</li>
</ul>
</li>
<li><strong><code>logQuestionMessageId(...)</code></strong>
<ul>
<li><strong>役割</strong>: Chatworkに送信した質問メッセージの情報を<code>BOT質問ログ</code>シートに追記する。</li>
</ul>
</li>
<li><strong><code>getPendingQuestionMessages()</code></strong>
<ul>
<li><strong>役割</strong>: <code>BOT質問ログ</code>シートから全てのログを読み込み、処理しやすいオブジェクトの配列に変換して返す。</li>
</ul>
</li>
<li><strong><code>updateQuestionStatus(...)</code></strong>
<ul>
<li><strong>役割</strong>: <code>BOT質問ログ</code>シート内の特定のメッセージIDのステータス（とエラー詳細）を更新する。</li>
</ul>
</li>
<li><strong><code>logReportToSheet(...)</code></strong>
<ul>
<li><strong>役割</strong>: 解析・評価が完了した日報データを<code>日報ログ</code>シートに追記する。</li>
</ul>
</li>
</ul>

<h3>4.4. Chatwork連携</h3>

<ul>
<li><strong><code>getChatworkApiKey()</code></strong>: スクリプトプロパティからChatwork APIキーを取得する。</li>
<li><strong><code>getChatworkTargetRoomIds()</code></strong>
<ul>
<li><strong>役割</strong>: <code>Chatwork設定</code>シートを読み込み、マネージャーと社員の情報を紐付けた、フラットな社員情報リストを生成する。</li>
<li><strong>処理フロー</strong>:
<ol>
<li>シートから全データを取得。</li>
<li>データをループし、役割が<code>manager</code>のユーザーと<code>employee</code>のユーザーをそれぞれ別の配列に格納。</li>
<li><code>employee</code>のリストをループし、<code>グループ名</code>をキーにして対応する<code>manager</code>情報を紐付ける。</li>
<li>最終的な <code>{employeeName, employeeRoomId, managerName, managerRoomId, weeklyReportMode, group, role}</code> の配列を返す。<code>weeklyReportMode</code>はマネージャーの設定が引き継がれる。</li>
</ol>
</li>
</ul>
</li>
<li><strong><code>getBotChatworkAccountId()</code></strong>: Chatwork APIの<code>/me</code>エンドポイントを叩き、BOT自身のChatworkアカウントIDを取得する。取得したIDはスクリプトプロパティにキャッシュする。</li>
<li><strong><code>sendDailyReportQuestions()</code></strong>: <code>getChatworkTargetRoomIds()</code>で取得した全社員に対し、未処理の日報がないか確認した上で、日報提出を促すメッセージを送信する。</li>
<li><strong><code>processChatworkReplies()</code></strong>: 未処理の質問がある社員のルームを対象に、Chatworkからメッセージを取得し、日報の返信を解析・処理する。</li>
<li><strong><code>getChatworkMessages(...)</code></strong>: Chatwork APIを呼び出し、指定されたルームのメッセージを取得する。</li>
<li><strong><code>sendChatworkNotification(...)</code></strong>: Chatwork APIを呼び出し、指定されたルームにメッセージを送信する汎用関数。</li>
</ul>

<h3>4.5. 日報データ処理・分析</h3>

<ul>
<li><strong><code>parseReportFromMessage(...)</code></strong>: Chatworkのメッセージ本文から、正規表現を用いて「業務内容」「気分」「困っていること」を抽出する。</li>
<li><strong><code>validateDailyReport(reportData)</code></strong>: 抽出した日報データが正しいフォーマットか（必須項目が埋まっているか、気分が選択肢内か）を検証する。</li>
<li><strong><code>assessAndNotify(...)</code></strong>: 日報データをGemini APIで評価し、結果に応じてマネージャーに通知し、ログを記録する一連の処理を統括する。</li>
</ul>

<h3>4.6. Gemini API関連</h3>

<ul>
<li><strong><code>getGeminiApiKey()</code></strong>: スクリプトプロパティからGemini APIキーを取得する。</li>
<li><strong><code>callGeminiApi(prompt)</code></strong>: Gemini APIの<code>generateContent</code>エンドポイントに対し、指定されたプロンプトを送信し、応答テキストを返す。</li>
</ul>

<h3>4.7. 1on1ヒアリング項目生成</h3>

<ul>
<li><strong><code>getDailyReportDataForEmployee(...)</code></strong>
<ul>
<li><strong>役割</strong>: <code>日報ログ</code>シートから特定社員の過去のデータを抽出し、1on1のためのサマリーを生成する。</li>
<li><strong>処理フロー</strong>:
<ol>
<li>対象社員の日報を<code>CONFIG.DAILY_REPORT_LOG_FETCH_DAYS_FOR_1ON1</code>で指定された期間分抽出。</li>
<li>気分の回数、<code>CONFIG.PROBLEM_KEYWORDS</code>の出現回数などを集計。</li>
<li>AI評価が「危険」または「少し悪い」の日報を優先的に収集し、代表的な日報として抜粋する。</li>
<li>その他の日報から、月ごとにランダムに選択し、代表的な日報として抜粋する（最大件数は<code>CONFIG.REPRESENTATIVE_REPORTS_COUNT</code>で設定）。</li>
<li>ポジティブな活動（新規機能リリース、顧客高評価、業務改善、目標達成など）を<code>CONFIG.POSITIVE_KEYWORDS</code>に基づいて集計する。</li>
<li>上記を組み合わせたハイブリッドな要約テキストを生成して返す。</li>
</ol>
</li>
</ul>
</li>
<li><strong><code>getSelfEvaluationDataForEmployee(...)</code></strong>
<ul>
<li><strong>役割</strong>: Googleドライブの指定フォルダから特定社員の自己評価シート（スプレッドシート）を検索し、その内容を解析してオブジェクトとして返す。</li>
<li><strong>処理フロー</strong>:
<ol>
<li>フォルダ内のファイルを検索し、ファイル名から対象シートを特定。</li>
<li>シートのヘッダーとデータ行を読み込む。</li>
<li>ヘッダー名に基づいて、各評価項目、コメント、目標などを抽出、構造化されたオブジェクトを生成する。</li>
</ol>
</li>
</ul>
</li>
<li><strong><code>generate1on1Topics()</code></strong>
<ul>
<li><strong>役割</strong>: 日報ログと自己評価シートのデータを基に、1on1のヒアリング項目を生成し、Chatworkに通知する。</li>
<li><strong>処理フロー</strong>:
<ol>
<li><code>getDailyReportDataForEmployee</code>と<code>getSelfEvaluationDataForEmployee</code>でデータを収集。</li>
<li>収集したデータを埋め込んだ、<strong>厳密な応答フォーマットを指定するテンプレート</strong>を使い、Gemini APIへのプロンプトを生成。</li>
<li><code>callGeminiApi</code>を呼び出す。</li>
<li>応答テキストを正規表現で解析し、<strong>質問と根拠のペアを抽出</strong>する。</li>
<li>抽出した内容を整形し、担当マネージャーに通知する。</li>
</ol>
</li>
</ul>
</li>
</ul>

<h3>4.8. 週次レポート生成機能</h3>

<ul>
<li><strong><code>generateWeeklyReports()</code></strong>
<ul>
<li><strong>役割</strong>: 週次レポートの生成と通知を統括するメイン関数。</li>
<li><strong>処理フロー</strong>:
<ol>
<li><code>getChatworkTargetRoomIds()</code> を呼び出し、全社員の情報を取得する。</li>
<li>マネージャーのルームIDをキーとして、担当社員、グループ名、週次レポートモード（<code>individual</code>/<code>team</code>）を含むオブジェクトを構築し、マネージャーごとにグループ化する。</li>
<li>マネージャーのグループごとにループ処理を行う。</li>
<li>各マネージャーの<code>weeklyReportMode</code>に応じて、<code>individual</code>モードまたは<code>team</code>モードの処理を呼び出す。</li>
<li><strong><code>individual</code>モードの場合</strong>:
<ul>
<li>担当社員ごとにループし、<code>getWeeklyRawReports()</code>で過去1週間分の日報データを取得。取得した生データは<code>generateIndividualReportWithGemini()</code>に渡され、整形されたレポートがマネージャー向けの単一のメッセージボディに追記される。</li>
<li>全社員のレポートを結合した後、最終的なレポートをマネージャーに通知する。</li>
</ul>
</li>
<li><strong><code>team</code>モードの場合</strong>:
<ul>
<li>担当社員のリストを<code>getWeeklyTeamReportSummaryForGroup()</code>に渡し、チーム全体のデータを集計。</li>
<li>集計データを<code>generateTeamSummaryReportWithGemini()</code>に渡し、Gemini APIでサマリーを生成。</li>
<li>生成されたサマリーを<code>【週次チームコンディションサマリー】</code>としてマネージャーに通知する。</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li><strong><code>getWeeklyRawReports(employeeName)</code></strong>
<ul>
<li><strong>役割</strong>: <code>日報ログ</code>シートから、指定された社員1名分の過去1週間分の日報データを抽出し、オブジェクトの配列として返す。フィルタリングには<code>タイムスタンプ</code>列を使用する。</li>
</ul>
</li>
<li><strong><code>getWeeklyTeamReportSummaryForGroup(employeeNames)</code></strong>
<ul>
<li><strong>役割</strong>: <code>日報ログ</code>シートから、指定された社員リスト（複数名）に該当する過去1週間分の日報データを全て抽出し、チーム全体の傾向（気分、課題、ポジティブな動き）を集計して返す。フィルタリングには<code>タイムスタンプ</code>列を使用する。</li>
</ul>
</li>
<li><strong><code>generateTeamSummaryReportWithGemini(summaryData, groupName)</code></strong>
<ul>
<li><strong>役割</strong>: 集計されたチーム日報データとグループ名を基に、Gemini APIを呼び出して週次チームコンディションサマリーレポートを生成する。</li>
</ul>
</li>
</ul>

<hr>
<p>最終更新日: 2025/07/23</p>
    </div>
</body>
</html>