# 日報分析ツール 仕様書

## 1. 概要

本ツールは、Google Apps Script (GAS) を用いて、日報の収集、AIによる分析、アラート通知、および結果のログ記録を自動化するシステムである。

## 2. 機能仕様

### 2.1. 日報収集機能

-   **トリガー**: Googleスプレッドシートのカスタムメニューから手動実行、または設定された日次トリガーにより自動実行。
-   **トリガー管理**: `createDailyTriggers()` 関数で日報質問送信、返信収集、ログクリーンアップの定期実行トリガーを設定し、`deleteTriggers()` 関数で全てのトリガーを削除する。
-   **実行時刻のカスタマイズ**: スクリプトプロパティ (`DAILY_QUESTION_TIME_HOUR`, `DAILY_QUESTION_TIME_MINUTE`) により、自動実行の時刻を分単位で設定可能。
-   **重複質問防止**: `BOT質問ログ` シートに、対象ルームIDの`未返信`、`返信済み_フォーマット不正`、`エラー発生`ステータスのレコードが存在する場合、質問メッセージの送信をスキップする。
-   **処理内容**: Chatwork APIを介し、事前に登録された全メンバーのダイレクトチャットに対し、日報提出を促す定型メッセージを送信する。送信後、そのメッセージIDと初期ステータス（`未返信`）を「BOT質問ログ」シートに記録する。
-   **送信メッセージ形式**: 
    ```
    #日報
    業務内容：
    気分：(良い/普通/悪い)
    困っていること：
    ```

### 2.2. 日報分析・通知機能

-   **トリガー**: Googleスプレッドシートのカスタムメニューから手動実行、または設定された日次トリガーにより自動実行。
-   **実行時刻のカスタマイズ**: スクリプトプロパティ (`DAILY_REPLY_COLLECT_TIME_HOUR`, `DAILY_REPLY_COLLECT_TIME_MINUTE`) により、自動実行の時刻を分単位で設定可能。
-   **処理内容**:
    1.  事前に登録された全メンバーのChatworkダイレクトチャットから、メッセージを取得する。
    2.  **`BOT質問ログ` シートに記録されている質問メッセージIDが、`返信済み_フォーマット不正`、`エラー発生`ステータスである場合、その質問に関する返信の処理を完全にスキップする。**
    3.  取得したメッセージの中から、BOT自身が送信したメッセージを除外する。
    4.  「BOT質問ログ」シートに記録された質問メッセージIDへの「返信」（引用形式）であるメッセージのみを日報として識別する。
    5.  識別された日報メッセージ本文に対し、以下のバリデーションを行う。
        -   `#日報` ハッシュタグが含まれていること。
        -   `氏名`、`今日の業務内容`、`今日の気分` が空でないこと。
        -   `今日の業務内容` が実質的に空（空白のみなど）でないこと。
        -   `今日の気分` が `良い`, `普通`, `悪い` のいずれかであること。
    6.  バリデーションに失敗した場合、その後のGemini分析、スプレッドシート記録、通常通知をスキップし、ログに詳細を出力する。**該当する「BOT質問ログ」のステータスを「`返信済み_フォーマット不正`」に更新する。**
    7.  バリデーションに成功した場合、抽出した日報データをGemini APIに送信し、提出者のコンディションを5段階（`非常に良い`, `良い`, `普通`, `少し悪い`, `危険`）で評価し、その理由と共に結果を取得する。**該当する「BOT質問ログ」のステータスを「`返信済み_処理成功`」に更新する。**
    8.  **日報処理中にエラーが発生した場合、該当する「BOT質問ログ」のステータスを「`エラー発生_API`」または「`エラー発生_その他`」に更新し、エラー詳細も記録する。**

### 2.3. ログ記録機能

-   **トリガー**: 日報分析処理（2.2）の完了後、自動で実行。
-   **処理内容**: 分析された全ての日報データ（Chatwork経由、Googleフォーム経由）とAIの評価結果を、指定のGoogleスプレッドシート（`日報ログ`シート）に1行ずつ追記する。
-   **記録項目**:
    -   タイムスタンプ
    -   氏名
    -   日報日付
    -   今日の業務内容
    -   今日の気分
    -   困っていること
    -   AI評価状態
    -   AI評価理由

### 2.4. 自己評価シート分析機能

-   **トリガー**: Googleスプレッドシートのカスタムメニューから手動実行。
-   **処理内容**:
    1.  スクリプトプロパティで指定されたGoogleドライブフォルダから、ファイル名に「自己評価」を含む**Googleスプレッドシート**を読み込む。
    2.  スプレッドシートの内容を読み込み、氏名列の情報を匿名化する。
    3.  匿名化された評価データを基にGemini APIにプロンプトを送信し、分析結果を取得する。
    4.  分析結果をマネージャーのChatwork個人チャットに通知する。
-   **設定項目**: スクリプトプロパティで以下の項目を設定する。
    -   `SELF_EVALUATION_FOLDER_ID`: 自己評価シートが格納されているGoogleドライブのフォルダID。
    -   `SELF_EVALUATION_NAME_COLUMN_HEADER`: 自己評価シート内の氏名列のヘッダー名（例: 「氏名」）。未設定の場合は「氏名」がデフォルト値となる。


## 3. 非機能仕様

-   **実行環境**: Google Apps Script
-   **外部連携API**:
    -   Google Gemini API
    -   Chatwork API
-   **設定管理**: APIキーやルームID、BOTアカウントIDなどの機密情報は、GASのスクリプトプロパティ機能を用いて安全に管理する。

---
最終更新日: 2025/07/04
