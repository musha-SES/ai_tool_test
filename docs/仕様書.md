# 日報分析ツール 仕様書

## 1. 概要

本ツールは、Google Apps Script (GAS) を用いて、Chatwork経由での日報収集、Gemini APIによる内容分析、分析結果に基づいたアラート通知、および全データのスプレッドシートへのログ記録を自動化するシステムである。また、蓄積された日報データと自己評価シートを基に、1on1面談のヒアリング項目を自動生成する機能も有する。

## 2. 機能要件

### 2.1. ユーザー・ルーム管理機能

-   **要件**: 日報提出の対象となる社員（employee）と、その報告先となる管理者（manager）の情報を、グループ単位で管理できること。
-   **仕様**:
    -   Googleスプレッドシートの`Chatwork設定`シートにて、ユーザー情報を管理する。
    -   `グループ名`列でマネージャーと社員の紐付けを行う。
    -   `役割`列に `manager` または `employee` を指定することで、役割を定義する。

### 2.2. 日報収集機能

-   **要件**: 定期的に全社員へ日報提出を促すメッセージを送信できること。
-   **仕様**:
    -   **トリガー**: 日次（時刻は`CONFIG`で設定可能）の自動トリガー、またはスプレッドシートのカスタムメニューからの手動実行。週次でBOT質問ログのクリーンアップも自動実行される。
        Apps Scriptの時限トリガーは、設定時刻の前後15分程度の範囲内で実行される可能性があり、正確な時刻の実行は保証されません（Googleのサーバー負荷による仕様）。
    -   **処理**:
        1. `Chatwork設定`シートに登録されている`employee`ロールの全ユーザーを対象とする。
        2. `BOT質問ログ`シートを参照し、対象者に未処理（未返信、エラー等）の日報要求がないか確認する。
        3. 未処理の日報がない場合のみ、日報提出を促す定型メッセージを対象者のChatworkルームに送信する。
        4. 送信したメッセージのID、時刻、ステータス（初期値: `未返信`）を`BOT質問ログ`シートに記録する。

### 2.3. 日報分析・通知機能

-   **要件**: 社員から提出された日報を解析し、内容に応じてマネージャーへ通知できること。
-   **仕様**:
    -   **トリガー**: 日次（時刻は`CONFIG`で設定可能）の自動トリガー、または手動実行。
    -   **処理**:
        1. `BOT質問ログ`シートから、ステータスが`返信済み_処理成功`以外の質問を取得する。
        2. 対象のChatworkルームから最新50件のメッセージを取得する。
        3. BOTが送信した質問への返信（リプライ）形式のメッセージを特定する。
        4. メッセージ本文に`#日報`タグが含まれていることを確認する。
        5. メッセージ本文から「業務内容」「気分」「困っていること」を正規表現で抽出する。
        6. **バリデーション**:
            -   業務内容が空でないこと。
            -   気分が`CONFIG.MOOD_OPTIONS`で定義された選択肢のいずれかであること。
            -   バリデーション失敗時は、`BOT質問ログ`のステータスを`返信済み_フォーマット不正`とし、処理を中断する。
        7. **AI分析**:
            -   バリデーション成功後、日報データを埋め込んだプロンプトを生成し、Gemini APIに送信する。
            -   APIから提出者の心理状態を4段階（良い、普通、少し悪い、悪い）＋危険で評価したJSON形式の応答を取得する。
        8. **アラート通知**:
            -   AIの評価が`危険`、`少し悪い`、`悪い`のいずれかの場合、または評価が`普通`で「困っていること」が`特になし`以外の場合、担当マネージャーのChatworkルームにアラートメッセージを送信する。
        9. **ログ記録**:
            -   分析された全ての日報データ、AIの評価結果、担当マネージャー名を`日報ログ`シートに記録する。
            -   `BOT質問ログ`のステータスを`返信済み_処理成功`または`エラー発生`に更新する。

### 2.4. 1on1ヒアリング項目生成機能

-   **要件**: 特定の社員の過去の活動記録に基づき、1on1面談で議論すべきトピックをAIが提案できること。
-   **仕様**:
    -   **トリガー**: スプレッドシートのカスタムメニューからの手動実行。
    -   **対象者指定**: スクリプトプロパティ `TARGET_EMPLOYEE_NAME_FOR_1ON1` で対象社員の氏名を指定する。
    -   **データ収集**:
        1.  **日報ログ**: `日報ログ`シートから、対象社員の過去`CONFIG.DAILY_REPORT_LOG_FETCH_DAYS_FOR_1ON1`日分の全日報を取得し、気分の傾向、頻出する課題キーワード、ポジティブな活動（新規機能リリース、顧客高評価、業務改善、目標達成など）などを集計・要約する。特にAI評価が「危険」または「少し悪い」の日報、および月ごとの代表的な日報を優先的に抜粋する。
        2. **自己評価**: Googleドライブの指定フォルダ（IDはスクリプトプロパティで指定）から、対象社員の「自己評価シート」を検索し、評価項目の内容やコメントを抽出する。
    -   **AIによる項目生成**:
        1. 日報サマリーと自己評価データを埋め込んだ、詳細なプロンプトを生成する。プロンプトには、回答フォーマット（質問と根拠をペアで記述）を厳密に指定する。
        2. Gemini APIを呼び出し、ヒアリング項目を5つ生成させる。
    -   **結果通知**:
        1. APIの応答を正規表現で解析し、質問と根拠を正確に分離・整形する。
        2. 整形した内容を、対象社員の担当マネージャーのChatworkルームに通知する。

### 2.5. 週次レポート生成機能

-   **要件**: マネージャーごとに設定されたレポートモード（個人別／チーム全体）に基づき、週次レポートを生成して自動通知できること。
-   **仕様**:
    -   **トリガー**: 週次（毎週月曜日、時刻は`createDailyTriggers`関数で設定）の自動トリガー、またはスプレッドシートのカスタムメニューからの手動実行。
    -   **処理**:
        1. `getChatworkTargetRoomIds` を実行し、全社員の情報を取得する。
        2. マネージャーのルームIDをキーとして、担当社員、グループ名、週次レポートモード（`individual`/`team`）を含むオブジェクトを構築し、マネージャーごとにグループ化する。
        3. マネージャーのグループごとにループ処理を行う。
        4. 各マネージャーの`weeklyReportMode`に応じて、`individual`モードまたは`team`モードの処理を呼び出す。
        5. **`individual`モードの場合**:
            - 担当社員ごとにループし、`getWeeklyRawReports()`で過去1週間分の日報データを取得。取得した生データは`generateIndividualReportWithGemini()`に渡され、整形されたレポートがマネージャー向けの単一のメッセージボディに追記される。
            - 全社員のレポートを結合した後、最終的なレポートをマネージャーに通知する。
        6. **`team`モードの場合**:
            - 担当社員のリストを`getWeeklyTeamReportSummaryForGroup()`に渡し、チーム全体の過去1週間の日報データを集計する。
            - 集計データが存在する場合、`generateTeamSummaryReportWithGemini` を実行し、Gemini APIを用いて「週次チームコンディションサマリー」を生成する。
            - 生成されたサマリーを担当マネージャーに通知する。

## 3. データ仕様

### 3.1. `Chatwork設定`シート

| 列 | ヘッダー名 | 説明 | データ型 |
| :--- | :--- | :--- | :--- |
| A | グループ名 | マネージャーと社員を紐付けるための任意のグループ名 | String |
| B | 氏名 | ユーザーの氏名 | String |
| C | ルームID | ChatworkのルームID | String |
| D | 役割 | `manager` または `employee` | String |
| E | 週次レポートモード | `manager`の行に設定。`team`または`individual`。空欄の場合は`individual`として動作する。 | String |

### 3.2. `日報ログ`シート

| 列 | ヘッダー名 | 説明 | データ型 |
| :--- | :--- | :--- | :--- |
| A | タイムスタンプ | ログが記録された日時 | Datetime |
| B | 氏名 | 日報提出者の氏名 | String |
| C | マネージャー名 | 担当マネージャーの氏名 | String |
| D | 日報日付 | 日報の対象日 | Datetime |
| E | 今日の業務内容 | 日報から抽出した業務内容 | String |
| F | 今日の気分 | 日報から抽出した気分 | String |
| G | 困っていること | 日報から抽出した困っていること | String |
| H | AI評価状態 | Gemini APIによる4段階評価（＋危険）の結果 | String |
| I | AI評価理由 | 上記評価の根拠 | String |

### 3.3. `BOT質問ログ`シート

| 列 | ヘッダー名 | 説明 | データ型 |
| :--- | :--- | :--- | :--- |
| A | ルームID | 質問を送信したChatworkのルームID | String |
| B | 質問ID | 送信した質問メッセージのID | String |
| C | 送信日時 | 質問を送信した日時 | Datetime |
| D | ステータス | `未返信`, `返信済み_処理成功`, `返信済み_フォーマット不正`, `エラー発生_...`など | String |
| E | エラー詳細 | エラー発生時の詳細情報 | String |

## 4. 外部連携API

-   **Chatwork API (v2)**
    -   `/me`: BOT自身のアカウントID取得に使用。
    -   `/rooms/{roomId}/messages`: メッセージの取得と送信に使用。
-   **Google Gemini API (v1beta)**
    -   `/models/gemini-2.0-flash:generateContent`: 日報分析と1on1トピック生成のコアロジックで使用。

---
最終更新日: 2025/07/17