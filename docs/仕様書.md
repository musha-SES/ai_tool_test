# 日報分析ツール 仕様書

## 1. 概要

本ツールは、Google Apps Script (GAS) を用いて、日報の収集、AIによる分析、アラート通知、および結果のログ記録を自動化するシステムである。

## 2. 機能仕様

### 2.1. ユーザー・ルーム管理

-   **管理方法**: Googleスプレッドシートの`Chatwork設定`シートで、日報提出の対象となる社員（employee）と、その報告先となる管理者（manager）の情報をグループ単位で管理する。
-   **シート構成**:
    | 列 | 内容 |
    | :--- | :--- |
    | グループ名 | マネージャーと社員を紐付けるための識別子。 |
    | 氏名 | Chatwork上の表示名。 |
    | ルームID | 各個人のChatworkルームID。 |
    | 役割 | `manager`または`employee`。 |

### 2.2. 日報収集機能

-   **トリガー**: Googleスプレッドシートのカスタムメニューから手動実行、または設定された日次トリガーにより自動実行。
-   **処理内容**: `Chatwork設定`シートに登録されている`employee`ロールの全ユーザーに対し、日報提出を促す定型メッセージを送信する。送信後、そのメッセージIDと初期ステータス（`未返信`）を`BOT質問ログ`シートに記録する。
-   **重複質問防止**: `BOT質問ログ`シートに、対象ルームIDの`未返信`、`返信済み_フォーマット不正`、`エラー発生`ステータスのレコードが存在する場合、その社員への質問メッセージの送信をスキップする。
-   **送信メッセージ形式**:
    ```
    [To:{roomId}] {name}さん\nおはようございます！\n本日の日報を以下のフォーマットでご返信ください。\n\n#日報\n業務内容：\n気分：(良い/普通/少し悪い/悪い)\n困っていること：
    ```

### 2.3. 日報分析・通知機能

-   **トリガー**: 手動実行、または日次トリガーにより自動実行。
-   **処理内容**:
    1.  `Chatwork設定`シートから全社員の情報を取得する。
    2.  各社員のChatworkダイレクトチャットからメッセージを取得し、BOTが送信した質問への返信であるかを識別する。
    3.  識別された日報メッセージ本文に対し、以下のバリデーションを行う。
        -   `#日報` ハッシュタグが含まれていること。
        -   `業務内容`が空でないこと。
        -   `気分` が `良い`, `普通`, `少し悪い`, `悪い` のいずれかであること。
    4.  バリデーションに失敗した場合、`BOT質問ログ`のステータスを`返信済み_フォーマット不正`に更新する。
    5.  バリデーションに成功した場合、日報データをGemini APIに送信し、コンディションを5段階で評価する。
    6.  評価結果が`危険`または`少し悪い`の場合、`Chatwork設定`シートで紐付けられた`manager`のChatworkにアラートを通知する。
    7.  処理が成功した場合、`BOT質問ログ`のステータスを`返信済み_処理成功`に更新する。

### 2.4. ログ記録機能

-   **トリガー**: 日報分析処理の完了後、自動で実行。
-   **処理内容**: 分析された全ての日報データをAIの評価結果、担当マネージャー名と共に`日報ログ`シートに記録する。
-   **記録項目**:
    -   タイムスタンプ
    -   マネージャー名
    -   氏名
    -   日報日付
    -   今日の業務内容
    -   今日の気分
    -   困っていること
    -   AI評価状態
    -   AI評価理由

### 2.5. 1on1ヒアリング項目生成機能

-   **トリガー**: Googleスプレッドシートのカスタムメニューから手動実行。
-   **処理内容**:
    1.  スクリプトプロパティ `TARGET_EMPLOYEE_NAME_FOR_1ON1` から対象社員の氏名を取得する。
    2.  スクリプトプロパティ `SELF_EVALUATION_FOLDER_ID` と `SELF_EVALUATION_INPUT_SHEET_NAME` から自己評価シートの情報を取得し、Googleドライブから対象社員の自己評価データを読み込む。
    3.  読み込んだ自己評価データを基にGemini APIでヒアリング項目を生成する。
    4.  `Chatwork設定`シートを参照し、対象社員の担当マネージャーを特定して、そのマネージャーのChatworkに結果を通知する。

## 3. 非機能仕様

-   **実行環境**: Google Apps Script
-   **外部連携API**: Google Gemini API, Chatwork API
-   **設定管理**: APIキーなどの機密情報はスクリプトプロパティで管理。ユーザーやルームIDは`Chatwork設定`シートで管理する。

---
最終更新日: 2025/07/07
